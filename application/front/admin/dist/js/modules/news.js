angular.module("Peaks.News",["Peaks.News.Repositories"]),angular.module("Peaks.News.Repositories",[]),angular.module("Peaks.News").controller("NewsCategoriesEditCtrl",["$scope","$http","$stateParams",function($scope,$http,$stateParams){$scope.section="news/categories",menuControl("news");var id=$stateParams.id;$scope.mode=id;var getThePage=function(){$http.get("/admin_news/get_category/"+id).success(function(data){console.log(data),$scope.item=data.content_items,init_page()})},getTheItems=function(limit,offset){$http.get("/admin_news/category_childs/"+id+"/"+limit+"/"+offset).success(function(data){$scope.totalItems=data.total_items,$scope.childs=data.items,init_page()})};$scope.currentPage=0,$scope.maxSize=5,$scope.itemPerPage=20,$scope.offset=0,$scope.setGetPage=function(pageNo){$scope.currentPage=pageNo,$scope.offset=$scope.currentPage*$scope.itemPerPage-$scope.itemPerPage,getTheItems($scope.itemPerPage,$scope.offset)},$scope.getView=function(id){window.location.hash="/news/items/"+id,block()},$scope.save=function(){$scope.alert="Sauvegarde",showAlert(),$http({url:"/admin_news/category_edit",method:"POST",data:$scope.item,headers:{"Content-Type":"application/json"}}).success(function(data){console.log(data),"new"==id&&0===data.errors.length?window.location.hash="/news/categories/"+data.id:($scope.alert=data.message,$scope.errors=data.errors,showFadeAlert())}).error(function(data){$scope.alert="Une erreure est survenue.",showFadeAlert(),console.log(data)})},$scope.delete=function(){$scope.alert="Supression",showAlert(),$http.get("/admin_news/category_delete/"+id).success(function(){window.location.hash="/news/categories"})},"new"===id?($scope.item={},init_page()):(getThePage(),getTheItems($scope.itemPerPage,0))}]),angular.module("Peaks.News").controller("NewsCategoriesListCtrl",["$scope","$http","$injector",function($scope,$http,$injector){var config={section:"news/categories",menu:"news",getUrl:"/admin_news/categories_list/",deleteUrl:"admin_news/category_delete/"};$scope.table=[{title:"Nom",param:"name"},{title:"Nbr de news",param:"childs_count"}],$scope.pageTitle="Catégories de news",$injector.invoke(ItemList,this,{$scope:$scope,$http:$http,config:config})}]),angular.module("Peaks.News").controller("NewsItemsEditCtrl",["$scope","$http","$stateParams","TagsRespository","NewsCategoriesRepository",function($scope,$http,$stateParams,tagsRespository,newsCategoriesRepository){function getCatagoryData(categoryId){newsCategoriesRepository.GetItem(categoryId,function(data){$scope.uploader.h=data.thumb_h,$scope.uploader.w=data.thumb_w})}function getThePage(){$http.get("/admin_news/get_news/"+id).success(function(data){console.log(data),$scope.item=data.content_items,$scope.person=data.person_info,$scope.today=data.today,getCatagoryData(data.content_items.parent_id),formatStatut(),init_page()})}function formatStatut(){$scope.statut=null==$scope.item.published_on?"draft":Date.parse($scope.item.published_on)>Date.parse($scope.today)?"pending":Date.parse($scope.item.archived_on)<=Date.parse($scope.today)?"archived":"online"}function getCategories(){$http.get("/admin_news/categories_list").success(function(data){$scope.categories=data.items})}init_page(),$scope.section="news/items",menuControl("news");var id=$stateParams.id;$scope.mode=id,$scope.faIcons=["fa-home","fa-pencil","fa-map-marker"],$scope.tinymceOptions=tinymceConfig,$scope.uploader={w:200,h:200,item_id:0,folder:"assets/images/news/"+id+"/thumbs/",assetPath:"news~"+id+"~thumbs",crop:1,uniqueName:!0},$scope.select2Tags={multiple:!0,simple_tags:!0,tokenSeparators:[","],initSelection:function(){console.log(this)}},tagsRespository.tagNamesList(function(data){$scope.select2Tags.tags=data}),$scope.assetsList={folder:"assets/images/news/"+id+"/",assetPath:"news~"+id,parentIdentity:"news_item"},$scope.$watch("item.parent_id",function(newValue){getCatagoryData(newValue)}),getCategories(),$scope.save=function(){"new"==id&&($scope.item.created_by=globalVars.user_id),console.log($scope.item),$http({url:"/admin_news/news_edit",method:"POST",data:$scope.item,headers:{"Content-Type":"application/json"}}).success(function(data){console.log(data),"new"==id&&0===data.errors.length?window.location.hash="/news/edit/"+data.id:($scope.alert=data.message,$scope.errors=data.errors,showFadeAlert(),formatStatut())}).error(function(){$scope.alert="Une erreure est survenue.",showFadeAlert()})},$scope.delete=function(){$http.get("/admin_news/delete/"+id).success(function(){window.location.hash="/news/list"})},$scope.pushOnline=function(){$http.get("/admin_news/push_online/"+id).success(function(){$scope.alert="News mise en ligne.",showFadeAlert(),$scope.item.published_on=$scope.today,formatStatut()})},$scope.pushOffline=function(){$http.get("/admin_news/push_offline/"+id).success(function(){$scope.alert="News archivée.",showFadeAlert(),$scope.item.archived_on=$scope.today,formatStatut()})},$("input").click(function(){$(".alert-container").fadeOut()}),"new"!=id?getThePage():($scope.hideForNew=!0,$scope.item={meta_tags:[]})}]),angular.module("Peaks.News").controller("NewsItemsListCtrl",["$scope","$http","$injector",function($scope,$http,$injector){var config={section:"news/items",menu:"news",getUrl:"/admin_news/news_list/",deleteUrl:"admin_news/delete_news/",getCallBack:function(data){var i=0;angular.forEach($scope.items,function(){$scope.items[i].statut=null==$scope.items[i].published_on?"warning":Date.parse($scope.items[i].published_on)>Date.parse(data.today)?"info":Date.parse($scope.items[i].archived_on)<=Date.parse(data.today)?"offline":"success",i++})}};$scope.table=[{title:"Titre",param:"title"},{title:"Catégorie",param:"category_name"},{title:"Auteur",param:"created_by"}],$scope.pageTitle="News",$injector.invoke(ItemList,this,{$scope:$scope,$http:$http,config:config})}]),angular.module("Peaks.News.Repositories").factory("NewsCategoriesRepository",["$http",function($http){return{GetItem:function(id,callback){$http.get("/admin_news/get_category/"+id).success(function(data){callback(data.content_items)})}}}]),angular.module("Peaks.News.Repositories").factory("NewsItemsRepository",["$http",function($http){return{GetItem:function(id,callback){$http.get("/admin_menus/item_details/"+id).success(function(data){callback(data)})},SaveItem:function(data,callback){$http({url:"/admin_menus/item_edit",method:"POST",data:data,headers:{"Content-Type":"application/json"}}).success(function(data){console.log(data),callback(data)}).error(function(){alert="Une erreure est survenue."})},ReorderItem:function(data,callback){$http({url:"/admin_menus/item_reorder",method:"POST",data:data,headers:{"Content-Type":"application/json"}}).success(function(data){console.log(data),callback(data)}).error(function(){alert="Une erreure est survenue."})},DeleteItem:function(id,callback){$http.get("/admin_menus/item_delete/"+id).success(function(data){callback(data)})}}}]);