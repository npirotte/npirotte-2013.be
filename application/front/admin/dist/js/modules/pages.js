angular.module("Peaks.Pages",["Peaks.Manager.Repositories","Peaks.Pages.Services","Peaks.Pages.Directives","Peaks.Pages.Repositories"]),angular.module("Peaks.Pages.Services",[]),angular.module("Peaks.Pages.Directives",[]),angular.module("Peaks.Pages.Repositories",[]),angular.module("Peaks.Pages").controller("MenuEditCtrl",["$scope","$stateParams","MenusMenusRepository",function($scope,$stateParams,menusMenusRepository){menuControl("pages"),$scope.backUrl="pages/menus";var id=$stateParams.id;$scope.mode=id;var getThePage=function(getTheChilds){menusMenusRepository.GetItem(id,function(data){$scope.item=data,init_page()})};$scope.save=function(returnToList){$scope.alert="Sauvegarde",showAlert(),menusMenusRepository.SaveItem($scope.item,function(data){returnToList&&0===data.errors.length?window.location.hash=$scope.backUrl:"new"==id&&0===data.errors.length?window.location.hash=$scope.backUrl+"/edit/"+data.id:($scope.alert=data.message,$scope.errors=data.errors,0===data.errors.length&&getThePage()),showFadeAlert()})},$scope.delete=function(){menusMenusRepository.DeleteItem(id,function(){window.location.hash=$scope.backUrl})},"new"===id?($scope.item={name:"",cssclass:""},init_page()):getThePage()}]),angular.module("Peaks.Pages").controller("MenusListCtrl",["$scope","$http","$injector",function($scope,$http,$injector){var config={section:"pages/menus",menu:"pages",getUrl:"/admin_menus/menus_list/",deleteUrl:"admin_menus/menu_delete/",getCallBack:function(){}};$scope.table=[{title:"Nom",param:"name",strong:!0}],$scope.pageTitle="Menu",$scope.thumbPath="",$injector.invoke(ItemList,this,{$scope:$scope,$http:$http,config:config})}]),angular.module("Peaks.Pages").controller("PageEditCtrl",["$rootScope","$scope","$stateParams","PagesRepository","TemplatesRepository","TagsRespository","GroupsRepository","_",function($rootScope,$scope,$stateParams,pagesRepository,templatesRepository,tagsRepository,groupsRepository,_){function getItem(getTemplateValues){pagesRepository.getPage(id,function(data){$scope.item=data.page_data;var userGroups=data.page_data.user_groups.split(",");$scope.userGroups=[],groupsRepository.GetGroups(function(data){$scope.userGroups=data,angular.forEach(data,function(item){item.checked=_.indexOf(userGroups,item.id)>=0})}),"template"===data.page_data.type&&getTemplateValues&&templatesRepository.getTemplateFields(data.page_data.template,function(data_sub){var i=0;data_sub.forEach(function(templateField){var fieldValue=_.findWhere(data.template_values,{field_name:templateField.full_name});fieldValue&&(data_sub[i++].fieldValue=_.findWhere(data.template_values,{field_name:templateField.full_name}).value)}),$scope.templateFields=data_sub})})}function autoGenerateSlug(){$scope.$watch("item.name",function(newValue){$scope.editForm.slug.$pristine&&($scope.item.slug=friendly_url(newValue))})}init_page(),menuControl("pages"),$scope.section="pages/pages";var id=$stateParams.pageId;$scope.mode=id;var saveIsBuzy=!1;$scope.tinymceOptions=tinymceConfig,$scope.aceLoaded=function(_editor){aceeditorConfig(_editor)},$scope.select2Tags={multiple:!0,simple_tags:!0,tokenSeparators:[","],initSelection:function(){console.log(this)}},tagsRepository.tagNamesList(function(data){$scope.select2Tags.tags=data}),$scope.$watch("item.lang",function(newValue){pagesRepository.getPageList(newValue,function(data){$scope.pagesList=new Array,$scope.pagesList.push({id:0,name:"root"}),$scope.pagesList=$scope.pagesList.concat(data.items)})}),templatesRepository.getTemplateFiles(function(data){$scope.templateFiles=data}),templatesRepository.getTemplates(function(data){$scope.templates=data.items}),$scope.getTemplateFields=function(){"template"===$scope.item.type&&templatesRepository.getTemplateFields($scope.item.template,function(data){$scope.templateFields=data})},$scope.save=function(returnToList){saveIsBuzy||(saveIsBuzy=!0,broadcast=!1,$scope.alert="Sauvegarde ...",showAlert(),"file"===$scope.item.type&&($scope.templateFields=!1),$scope.item.user_groups="",angular.forEach($scope.userGroups,function(group){group.checked&&($scope.item.user_groups+=group.id+",")}),$scope.item.user_groups=$scope.item.user_groups.substring(0,$scope.item.user_groups.length-1),console.log($scope.userGroups),"new"==id||$scope.item.parent_id==$scope.item.cache.parent_id&&$scope.item.weight==$scope.item.cache.weight||(broadcast=!0),console.log($scope.item),pagesRepository.savePage($scope.item,$scope.templateFields,function(data){saveIsBuzy=!1,returnToList&&0===data.errors.length?window.location.hash="/pages/pages":"new"==id&&0===data.errors.length?window.location.hash="/pages/pages/edit/"+data.id:($scope.alert=data.message,$scope.errors=data.errors,0==data.error&&($scope.item.version=data.version,getItem(),broadcast&&$rootScope.$broadcast("siteMapUpdatedByPageCtrl")),showFadeAlert())}))},$scope.delete=function(){confirm('Etes vous sur de vouloir supprimer la page "'+$scope.item.name+'" ?')&&pagesRepository.deletePage($scope.item.id,function(){window.location.hash="/pages/pages"})},"new"!=id?($scope.$on("siteMapUpdatedBySiteMap",function(){pagesRepository.getPageOrder($scope.item.id,function(pageOrder){$scope.item.cache.parent_id!=pageOrder.parent_id&&($scope.item.cache.parent_id=pageOrder.parent_id,$scope.item.parent_id=pageOrder.parent_id),$scope.item.cache.weight!=pageOrder.weight&&($scope.item.cache.weight=pageOrder.weight,$scope.item.weight=pageOrder.weight)})}),getItem(!0)):(autoGenerateSlug(),console.log($rootScope.newItem),$scope.newItem?($scope.item=$rootScope.newItem,$scope.item.meta_keywords=new Array,$rootScope.newItem=void 0):$scope.item={meta_keywords:new Array})}]),angular.module("Peaks.Pages").controller("PageListCtrl",["$scope","$http","$injector",function($scope,$http,$injector){var config={section:"pages/pages",menu:"pages",getUrl:"/admin_pages/pages_list/",deleteUrl:"admin_pages/pages_delete/"};$scope.table=[{title:"Nom",param:"name",strong:!0},{title:"Langue",param:"lang"},{title:"Versions",param:"version"}],$scope.pageTitle="Pages",$scope.thumbPath="users~thumbs",$injector.invoke(ItemList,this,{$scope:$scope,$http:$http,config:config})}]),angular.module("Peaks.Pages").controller("TemplateEditCtrl",["$scope","$http","$stateParams","TemplatesRepository",function($scope,$http,$stateParams,templatesRepository){function getItem(){templatesRepository.getTemplate(id,function(data){$scope.item=data})}function aceLoaded(_editor){console.log(_editor),_editor.setReadOnly(!0),ace.require("ace/ext/emmet"),ace.require("ace/ext/language_tools"),_editor.setOptions({enableBasicAutocompletion:!0,enableEmmet:!0,enableSnippets:!0})}init_page(),$scope.section="pages/templates",menuControl("pages");var id=$stateParams.id;$scope.mode=id,templatesRepository.getTemplateFiles(function(data){$scope.templateFiles=data}),$scope.aceConfig={useWrapMode:!0,showGutter:!0,theme:"twilight",mode:"html",onLoad:aceLoaded},$scope.save=function(returnToList){$scope.alert="Sauvegarde",showAlert(),templatesRepository.saveTemplate($scope.item,function(data){returnToList&&0===data.errors.length?window.location.hash="/pages/templates":"new"==id&&0===data.errors.length?window.location.hash="/pages/templates/edit/"+data.id:($scope.alert=data.message,$scope.errors=data.errors),showFadeAlert()})},$scope.delete=function(){templatesRepository.deleteTemplete(id,function(){window.location.hash=$scope.section})},"new"!=id&&getItem()}]),angular.module("Peaks.Pages").controller("TemplatesListCtrl",["$scope","$http","$injector",function($scope,$http,$injector){var config={section:"pages/templates",menu:"pages",getUrl:"/admin_pages/templates_list/",deleteUrl:"admin_pages/templates_delete"};$scope.table=[{title:"Nom",param:"name"}],$scope.pageTitle="Templates",$injector.invoke(ItemList,this,{$scope:$scope,$http:$http,config:config})}]),angular.module("Peaks.Pages.Directives").directive("menusItemsPanel",["MenusItemsRepository","UrlService",function(menusItemsRepository,urlService){return{scope:{menuId:"=menuId"},controller:function($scope){function getItem(id){menusItemsRepository.GetItem(id,function(data){data.target=1==data.target?!0:!1,$scope.item=data})}function resetItem(parentId){$scope.item={menu_id:$scope.menuId,parent_id:parentId?parentId:null},$scope.urlOptions=[],$scope.itemForm.$setPristine()}function getItemList(){menusItemsRepository.GetItemsTree($scope.menuId,function(data){$scope.itemsTree=data}),menusItemsRepository.GetItems($scope.menuId).then(function(result){$scope.itemsList=result.data.items})}var runing=!1;$scope.urlOptions=[],$scope.getItem=function(id){getItem(id)},getItemList(),$scope.resetItem=function(){resetItem()},$scope.save=function(endEdit){return runing?!1:(runing=!0,$scope.item.menu_id||($scope.item.menu_id=$scope.menuId),console.log("run"),void menusItemsRepository.SaveItem($scope.item,function(data){runing=!1,0===data.errors.length&&(endEdit?resetItem():getItem(data.id),getItemList())}))},$scope.newSubItem=function(parentId){resetItem(parentId)},$scope.deleteItem=function(id,reset){bootbox.confirm("Etes vous sur de vouloir supprimer cet élément ?",function(invoke){invoke&&menusItemsRepository.DeleteItem(id,function(){getItemList(),reset&&resetItem()})})},$scope.$watch("item.module",function(newValue){$scope.urlOptions.UrlFunctions=urlService.GetFunctions(newValue)}),$scope.$watch("item.function",function(newValue){$scope.item&&urlService.GetElements($scope.item.module,newValue,function(data){console.log(data),$scope.urlOptions.UrlElements=data})}),$scope.treeOptions={dropped:function(event){var parentChildsList,data={};try{data.parent_id=event.dest.nodesScope.$nodeScope.$modelValue.id}catch(e){data.parent_id=0}try{data.old_parent_id=event.source.nodesScope.$nodeScope.$modelValue.id}catch(e){data.old_parent_id=0}return data.new_index=event.dest.index,parentChildsList=event.dest.nodesScope.$modelValue,data.id=parentChildsList[data.new_index].id,data.menu_id=$scope.menuId,(event.source.index!=data.new_index||data.parent_id!=data.old_parent_id)&&menusItemsRepository.ReorderItem(data,function(){}),!0}}},restrict:"A",templateUrl:"/admin/view_loader/desktop/menus/items/edit",replace:!1}}]),angular.module("Peaks.Pages.Directives").directive("pagesSiteMap",["PagesRepository",function(pagesRepository){return{scope:{currentId:"=current"},templateUrl:"/admin/view_loader/desktop/shared/widgets/tree",controller:function($rootScope,$scope){function languagesMap(languages){var result={};for(var key in languages)result[key]={KeyName:key,LangName:languages[key]};return result}function getData(){pagesRepository.siteMap($scope.treeCulture,function(data){$scope.data=data})}$scope.smallSize="small-size",$scope.languages=languagesMap(globalVars.siteLanguages),$scope.treeCulture=globalVars.defaultLanguage,$scope.remove=function(scope){scope.remove()},$scope.toggle=function(scope){scope.toggle()},$scope.newSubItem=function(id){$rootScope.newItem={parent_id:id,lang:"fr"},window.location.hash="/pages/pages/edit/new",console.log(id)},$scope.getPage=function(id){window.location.hash="/pages/pages/edit/"+id};var getRootNodesScope=function(){return angular.element(document.getElementById("tree-root")).scope()};$scope.collapseAll=function(){var scope=getRootNodesScope();scope.collapseAll()},$scope.expandAll=function(){var scope=getRootNodesScope();scope.expandAll()},$scope.treeOptions={dropped:function(event){var parentChildsList,data={};try{data.parent_id=event.dest.nodesScope.$nodeScope.$modelValue.id}catch(e){data.parent_id=0}try{data.old_parent_id=event.source.nodesScope.$nodeScope.$modelValue.id}catch(e){data.old_parent_id=0}return data.new_index=event.dest.index,parentChildsList=event.dest.nodesScope.$modelValue,data.item_id=parentChildsList[data.new_index].id,data.lang="fr",(event.source.index!=data.new_index||data.parent_id!=data.old_parent_id)&&pagesRepository.reorder(data,function(){$rootScope.$broadcast("siteMapUpdatedBySiteMap")}),!0}},$scope.$watch("treeCulture",function(){getData()}),getData(),$scope.$on("siteMapUpdatedByPageCtrl",function(){getData()})}}}]),angular.module("Peaks.Pages.Repositories").factory("MenusItemsRepository",["$http",function($http){return{GetItemsTree:function(menuId,callback){$http.get("/admin_menus/items_list/"+menuId+"/true").success(function(data){callback(data)})},GetItems:function(menuId){return $http.get("/admin_menus/items_list/"+menuId)},GetItem:function(id,callback){$http.get("/admin_menus/item_details/"+id).success(function(data){callback(data)})},SaveItem:function(data,callback){$http({url:"/admin_menus/item_edit",method:"POST",data:data,headers:{"Content-Type":"application/json"}}).success(function(data){console.log(data),callback(data)}).error(function(){alert="Une erreure est survenue."})},ReorderItem:function(data,callback){$http({url:"/admin_menus/item_reorder",method:"POST",data:data,headers:{"Content-Type":"application/json"}}).success(function(data){console.log(data),callback(data)}).error(function(){alert="Une erreure est survenue."})},DeleteItem:function(id,callback){$http.get("/admin_menus/item_delete/"+id).success(function(data){callback(data)})}}}]),angular.module("Peaks.Pages.Repositories").factory("MenusMenusRepository",["$http",function($http){return{GetItem:function(id,callback){$http.get("/admin_menus/menu_details/"+id).success(function(data){callback(data)})},SaveItem:function(data,callback){$http({url:"/admin_menus/menu_edit",method:"POST",data:data,headers:{"Content-Type":"application/json"}}).success(function(data){console.log(data),callback(data)}).error(function(){alert="Une erreure est survenue."})},DeleteItem:function(id,callback){$http.get("/admin_menus/menu_delete/"+id).success(function(data){callback(data)})}}}]),angular.module("Peaks.Pages.Repositories").factory("PagesRepository",["$http",function($http){return{getPage:function(id,callback){$http.get("/admin_pages/pages_details/"+id).success(function(data){callback(data)})},savePage:function(page_data,template_values,callback){var data={};data.page_data=page_data,"template"===page_data.type&&(data.template_values=template_values),$http({url:"/admin_pages/page_edit",method:"POST",data:data,headers:{"Content-Type":"application/json"}}).success(function(data){console.log(data),callback(data)}).error(function(){alert="Une erreure est survenue."})},deletePage:function(id,callback){$http.get("/admin_pages/pages_delete/"+id).success(function(data){callback(data)})},reorder:function(data,callback){$http({url:"/admin_pages/page_reorder",method:"POST",data:data,headers:{"Content-Type":"application/json"}}).success(function(data){callback(),console.log(data)}).error(function(){alert="Une erreure est survenue."})},getPageOrder:function(id,callback){$http.get("/admin_pages/get_page_order/"+id).success(function(data){console.log(data),callback(data)})},getPageList:function(lang,callback){$http.get("/admin_pages/pages_list/0/0/"+lang).success(function(data){console.log(data),callback(data)})},siteMap:function(lang,callback){$http.get("/admin_pages/site_map/"+lang).success(function(data){callback(data)})}}}]),angular.module("Peaks.Pages.Repositories").factory("TemplatesRepository",["$http",function($http){new Array;return{getTemplate:function(id,callback){$http.get("/admin_pages/templates_details/"+id).success(function(data){callback(data)})},getTemplateFiles:function(callback){$http.get("/admin_pages/template_files_list").success(function(data){callback(data)})},getTemplates:function(callback){$http.get("./admin_pages/templates_list").success(function(data){callback(data)})},saveTemplate:function(data,callback){$http({url:"/admin_pages/templates_edit",method:"POST",data:data,headers:{"Content-Type":"application/json"}}).success(function(data){console.log(data),callback(data)}).error(function(){alert="Une erreure est survenue."})},deleteTemplete:function(id,callback){$http.get("/admin_pages/templates_delete/"+id).success(function(data){callback(data)})},getTemplateFields:function(id,callback){$http.get("/admin_pages/templates_fields_list/"+id).success(function(data){callback(data)})}}}]);